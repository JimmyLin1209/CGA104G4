<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>商品管理頁面</title>
    <!-- 響應式頁面 -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- ↓↓↓下面是這個版需要的css可添加各自需要的css檔-->

    <!-- Bootstrap Styles-->
    <link href=../resources/back-stage/assets/css/bootstrap.css rel="stylesheet" />
    <!-- FontAwesome Styles-->
    <link href=../resources/back-stage/assets/css/font-awesome.css rel="stylesheet" />
    <!-- Google Fonts-->
    <link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css' />
    <!-- Custom Styles-->
    <link href=../resources/back-stage/assets/css/custom-styles.css rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.6.1.min.js"></script>
    <!-- ↑↑↑下面是這個版需要的css可添加各自需要的css檔-->

    <style>
        div.flexdiv {
            display: flex;
            justify-content: space-around;
            gap: 30px;
            width: 70%;
            margin-bottom: 2rem;
        }
        img.memPic{
            width: 60px;
            height: auto;
        }

        table {
            border-collapse: separate;
            border-spacing: 0;
            width: 100%;
            margin-left: auto;
            margin-right: auto;
        }
        th {
            background: #42444e;
            color: #fff;
            text-align: center;
        }
        tr{
            text-align: center;
        }
        tr:first-child th:first-child {
            border-top-left-radius: 6px;
        }
        tr:first-child th:last-child {
            border-top-right-radius: 6px;
        }
        td {
            border-right: 1px solid #c6c9cc;
            border-bottom: 1px solid #c6c9cc;
        }
        td:first-child {
            border-left: 1px solid #c6c9cc;
        }
        tr:nth-child(even) td {
            background: #eaeaed;
        }
        tr:last-child td:first-child {
            border-bottom-left-radius: 6px;
        }
        tr:last-child td:last-child {
            border-bottom-right-radius: 6px;
        }
        select:disabled{
            color: black;
            opacity: 1;
        }

    </style>
</head>

<body>
<!-- 從這複製↓↓↓ -->

<div id="wrapper">
    <!-- 上方Nav ↓↓↓  -->
    <nav class="navbar navbar-default top-navbar" role="navigation">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".sidebar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="index.html"><strong>後台管理</strong></a>
        </div>

        <ul class="nav navbar-top-links navbar-right">
            <!-- /.dropdown -->
            <li class="dropdown">
                <a class="dropdown-toggle" data-toggle="dropdown" href="#" aria-expanded="false">
                    <i class="fa fa-user fa-fw"></i> <i class="fa fa-caret-down"></i>
                </a>
                <ul class="dropdown-menu dropdown-user">
                    <li><a href="#"><i class="fa fa-sign-in fa-fw"></i>登入</a>
                    </li>
                    <li><a href="#"><i class="fa fa-sign-out fa-fw"></i> 登出</a>
                    </li>
                </ul>
                <!-- /.dropdown-user -->
            </li>
            <!-- /.dropdown -->
        </ul>
    </nav>
    <!-- 上方Nav ↑↑↑  -->
    <!-- 左側Nav ↓↓↓  -->
    <nav class="navbar-default navbar-side" role="navigation">
        <div class="sidebar-collapse">
            <ul class="nav" id="main-menu">

                <li>
                    <a class="active-menu" href="#"><i class="fa fa-dashboard"></i> 吉食享樂</a>
                </li>

                <li>
                    <a href="#">一般商品<span class="fa arrow"></span></a>
                    <ul class="nav nav-second-level">
                        <li>
                            <a href="#">一般商品管理</a>
                        </li>
                        <li>
                            <a href="#">一般訂單管理</a>
                        </li>
                    </ul>
                </li>

                <li>
                    <a href="#">福袋商品<span class="fa arrow"></span></a>
                    <ul class="nav nav-second-level">
                        <li>
                            <a href="#">福袋商品管理</a>
                        </li>
                        <li>
                            <a href="#">福袋訂單管理</a>
                        </li>
                    </ul>
                </li>


                <li>
                    <a href="#">員工帳號管理<span class="fa arrow"></span></a>
                    <ul class="nav nav-second-level">
                        <li>
                            <a href="#">員工帳號管理</a>
                        </li>
                        <li>
                            <a href="#">員工權限管理</a>
                        </li>
                    </ul>
                </li>
                <li>
                    <a href="#">代幣系統管理<span class="fa arrow"></span></a>
                    <ul class="nav nav-second-level">
                        <li>
                            <a href="#">客訴處理</a>
                        </li>
                        <li>
                            <a href="#">優惠活動管理</a>
                        </li>
                        <li>
                            <a href="#">代幣儲值</a>
                        </li>
                    </ul>
                </li>
                <li>
                    <a href="#">會員管理<span class="fa arrow"></span></a>
                    <ul class="nav nav-second-level">
                        <li>
                            <a href="#">合作店家資格審核</a>
                        </li>
                        <li>
                            <a href="#">合作店家帳號管理</a>
                        </li>
                        <li>
                            <a href="#">一般會員管理</a>
                        </li>
                    </ul>
                </li>

                <li>
                    <a href="#"> 評論檢舉管理 </a>
                </li>

            </ul>

        </div>

    </nav>
    <!-- 左側Nav ↑↑↑  -->

    <div id="page-wrapper">
        <div id="wrapper-container">
            <!-- ******內容寫在這邊 ↓↓↓****** -->
            <div class="flexdiv">
                <div>
                    <span>選擇商品類型編號:</span>
                    <select id="prodTypeIdSelecter" name="prodTypeId"></select>
                    <button id="prodRypeIdSelecterButton">搜索</button>
                </div>
                <div>
                    <span>輸入商品類型編號:</span>
                    <input type="text" id="selectByInputinput" name="prodTypeId">
                    <button id="selectByInputbutton">搜索</button>
                </div>
                <div>
                    <button id="getAll">顯示所有商品類型</button>
                </div>
            </div>
            <div id="listTable"></div>
            <!-- ******內容寫在這邊 ↑↑↑****** -->
        </div>
    </div>

</div>
<!-- 複製到這裡↑↑↑ -->


<script>

    //儲存商品類型編號用陣列
    let prodTypeIdArray = [];

    //頁面載入取得商品類型編號選單
    (async function getProdTypeId() {
        let path = window.location.pathname;
        let webCtx = path.substring(0, path.indexOf('/', 1));
        let url = webCtx + "/prodType/prodType.do?action=listProds_ByProdTypeId_A";
        let response = await fetch(url, {method: 'get'});
        prodTypeIdArray = await response.json();
        $("#prodTypeIdSelecter").empty();
        prodTypeIdArray.forEach(prodTypeId => {
            $("#prodTypeIdSelecter").append(`<option  value="${prodTypeId}">${prodTypeId}</option>`)
        })
    })();

    //綁定選單商品類型編號查詢按鈕點擊事件
    $("#prodTypeIdSelecterButton").click(selectById);

    //透過選單查詢商品類型資料
    async function selectById() {
        let prodTypeIdId = $("#prodTypeIdSelecter").val();
        let path = window.location.pathname;
        let webCtx = path.substring(0, path.indexOf('/', 1));
        let url = webCtx + "/prodType/prodType.do?action=selectById&prodTypeId=" + prodTypeId;
        let response = await fetch(url, { method: 'get' });
        let prods = await response.json();
        listProds(prods);
    }

    //綁定輸入會員編號查詢按鈕事件
    $("#selectByInputbutton").click(checkInputProdTypeId);
    //確認輸入編號是否正確
    function checkInputProdTypeId() {
        let prodTypeId = $("#selectByInputinput").val();
        let evdience = false;
        for (let i = 0; i < prodTypeIdArray.length; i++) {
            if (prodTypeId == +prodTypeIdArray[i]) {
                evdience = true;
                break;
            }
        }
        if(!evdience){
            alert("輸入的商品類別編號有誤");
            return;
        }

        getProdsByInput(prodTypeId);
    };

    async function getProdsByInput(prodTypeId){
        let path = window.location.pathname;
        let webCtx = path.substring(0, path.indexOf('/', 1));
        let url = webCtx + "/prodType/prodType.do?action=selectById&prodTypeId=" + prodTypeId;

        let response = await fetch(url, { method: 'get' });
        let prods = await response.json();
        listProds(prods);
    }


    //綁定顯示所有商品類型資料按鈕事件
    $("#getAll").click(getAll)

    //取得所有商品類型資料
    async function getAll() {
        let path = window.location.pathname;
        let webCtx = path.substring(0, path.indexOf('/', 1));
        let url = webCtx + "/prodType/prodType.do?action=getAll";

        let response = await fetch(url, { method: 'get' });
        let prods = await response.json();
        listProds(prods);


    }
    //動態生成表格會員表格
    function listProds(prods) {
        //移除原本存在的表格
        $("#listTable").empty();

        //生成表格
        let table = document.createElement("table");

        //生成表頭
        table.innerHTML += "<thead><tr><th>商品編號</th><th>商家編號</th>"
            + "<th>商品類型編號</th><th>狀態</th><th>介紹</th><th>單價</th><th>上架時間</th></tr></thead>";

        //生成表格內容
        let tbody = document.createElement("tbody");

        //循環依人數生成表格數量
        for (let i = 0; i < prods.length; i++) {
            //處理註冊時間
            let date = new Date(prods[i].prodRegTime).toLocaleDateString();

            //修改會員狀態顯示結果不顯示數字而是文字

            let tr = document.createElement("tr");
            tr.insertAdjacentHTML("beforeend", `<td>${prods[i].prodId}</td>`);
            tr.insertAdjacentHTML("beforeend", `<td>${prods[i].storeId}</td>`);
            tr.insertAdjacentHTML("beforeend", `<td>${prods[i].prodTypeId}</td>`);
            tr.insertAdjacentHTML("beforeend", `<td>${prods[i].prodStat}</td>`);
            tr.insertAdjacentHTML("beforeend", `<td>${prods[i].prodCont}</td>`);
            tr.insertAdjacentHTML("beforeend", `<td>${prods[i].prodPrc}</td>`);
            tr.insertAdjacentHTML("beforeend", `<td>${prods[i].prodTime}</td>`);
           
            if (prods[i].prodPic) {
                tr.insertAdjacentHTML("beforeend", `<td><img class="prodPic" src=data:image/jpeg;base64,${prods[i].prodPic}></td>`);
            } else {
                tr.insertAdjacentHTML("beforeend", `<td></td>`);
            }

            if(prods[i].prodStat === 0){
                tr.insertAdjacentHTML("beforeend", `<td><select disabled id="select${prods[i].prodId}"><option selected value="0">下架不顯示</option><option value="1">上架顯示</option></select></td>`);
            }else {
                tr.insertAdjacentHTML("beforeend", `<td><select disabled id="select${prods[i].prodId}"><option selected value="0">下架不顯示</option><option selected value="1">上架顯示</option></select></td>`);
            }
            let buttonhtml = "<td><button id='prodStateModify' name='aSTMbutton"+prods[i].prodId+"' value='"+prods[i].prodId+ "'>修改商品狀態</button>" +
                             "<button style='display: none;margin-right: 0.5rem' id='cfbutton"+prods[i].prodId+"'value='"+prods[i].prodId+ "'>確認</button>"+
                             "<button style='display: none' id='clbutton"+prods[i].prodId+"'value='"+prods[i].prodId+ "'>取消</button></td>"

            tr.insertAdjacentHTML("beforeend", buttonhtml);

            tr.insertAdjacentHTML("beforeend", `<td><button id="prodTopUpList" value="${prods[i].prodId}">待確認</button></td></td>`);

            tbody.append(tr);
            tbody.append(tr);
        }
        table.append(tbody);
        table.setAttribute("class", "tableclass");
        $("#listTable").append(table);


        //綁定修改商品狀態與待確認事件
        addTableButtonWithFunction();
    }
    //綁定修改商品狀態與查詢待確認事件
    function addTableButtonWithFunction() {
        document.querySelectorAll("#prodStateModify").forEach(e => e.addEventListener('click', prodStateModify));

        document.querySelectorAll("button[id^='cfbutton']").forEach(e=>e.addEventListener('click',updateProdState));

        document.querySelectorAll("button[id^='clbutton']").forEach(e=>e.addEventListener('click',recoverProdState));

        // let prodTopUpListbutton = document.querySelectorAll("#prodTopUpList");
        // prodTopUpListbutton.forEach(e => e.addEventListener('click', prodTopUpList));
    }
    let OriginalProdState;
    function prodStateModify(e){
        let prodId =  e.target.value;
        let selected = "select"+prodId;
        let aSTMbutton = "aSTMbutton"+prodId;

        OriginalProdState = $(`#${selected}`).val();

        $(`#${selected}`).prop("disabled",false);
        $(`[name=${aSTMbutton}]`).hide();
        $("#cfbutton"+prodId).show();
        $("#clbutton"+prodId).show();


    }

    function updateProdState(e){
        let prodId =  e.target.value;
        let selected = "select"+prodId;
        let aSTMbutton = "aSTMbutton"+prodId;

        $(`#${selected}`).prop("disabled",true);
        $(`[name=${aSTMbutton}]`).show();
        $("#cfbutton"+prodId).hide();
        $("#clbutton"+prodId).hide();
         let prodState = $(`#${selected}`).val();

        let path = window.location.pathname;
        let webCtx = path.substring(0, path.indexOf('/', 1));
        let url = webCtx + "/prodType/prodType.do?action=updateProdState&prodState="+prodState+"&prodId="+prodId;
        fetch(url, { method: 'get' });
    }

    function recoverAccState(e){
        let prodTypeId =  e.target.value;
        let selected = "select"+prodTypeId;
        let aSTMbutton = "aSTMbutton"+prodTypeId;

        $(`#${selected}`).prop("disabled",true);
        $(`[name=${aSTMbutton}]`).show();
        $("#cfbutton"+prodTypeId).hide();
        $("#clbutton"+prodTypeId).hide();
        $(`#${selected}`).children(`[value='${OriginalProdState}']`).prop("selected",true);
    }





</script>
<!-- ↓↓↓下面是這個版需要的js可添加各自需要的js檔-->

<!-- jQuery Js -->
<script src=../resources/back-stage/assets/js/jquery-1.10.2.js></script>
<!-- Bootstrap Js -->
<script src=../resources/back-stage/assets/js/bootstrap.min.js></script>
<!-- 左側Nav Dropdown -->
<script src=../resources/back-stage/assets/js/jquery.metisMenu.js></script>
<!-- Custom Js -->
<script src=../resources/back-stage/assets/js/custom-scripts.js></script>

<!-- ↑↑↑下面是這個版需要的js可添加各自需要的js檔-->
</body>
</html>