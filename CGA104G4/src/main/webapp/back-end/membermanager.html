<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>會員管理頁面</title>
    <script src="https://code.jquery.com/jquery-3.6.1.min.js"></script>
    <style>
        div.flexdiv {
            display: flex;
            justify-content: space-around;
            gap: 30px;
            width: 70%;
            margin-bottom: 2rem;
        }
        img.memPic{
            width: 60px;
            height: auto;
        }

        table {
            border-collapse: separate;
            border-spacing: 0;
            width: 100%;
            margin-left: auto;
            margin-right: auto;
        }
        th {
            background: #42444e;
            color: #fff;
            text-align: center;
        }
        tr{
            text-align: center;
        }
        tr:first-child th:first-child {
            border-top-left-radius: 6px;
        }
        tr:first-child th:last-child {
            border-top-right-radius: 6px;
        }
        td {
            border-right: 1px solid #c6c9cc;
            border-bottom: 1px solid #c6c9cc;
        }
        td:first-child {
            border-left: 1px solid #c6c9cc;
        }
        tr:nth-child(even) td {
            background: #eaeaed;
        }
        tr:last-child td:first-child {
            border-bottom-left-radius: 6px;
        }
        tr:last-child td:last-child {
            border-bottom-right-radius: 6px;
        }
        select:disabled{
            color: black;
            opacity: 1;
        }

    </style>
</head>

<body>
<div class="flexdiv">
    <div>
        <span>選擇會員編號:</span>
        <select id="memIdSelecter" name="memId"></select>
        <button id="memIdSelecterButton">搜索</button>
    </div>
    <div>
        <span>輸入會員編號:</span>
        <input type="text" id="selectByInputinput" name="memId">
        <button id="selectByInputbutton">搜索</button>
    </div>
    <div>
        <button id="getAll">顯示所有會員</button>
    </div>
</div>
<div id="listTable"></div>

<script>

    //儲存會員編號用陣列
    let memIdArray = [];

    //頁面載入取得會員編號選單
    (async function getMemId() {
        let path = window.location.pathname;
        let webCtx = path.substring(0, path.indexOf('/', 1));
        let url = webCtx + "/member/member.do?action=getMemId";
        let response = await fetch(url, {method: 'get'});
        memIdArray = await response.json();
        $("#memIdSelecter").empty();
        memIdArray.forEach(memId => {
            $("#memIdSelecter").append(`<option  value="${memId}">${memId}</option>`)
        })
    })();

    //綁定選單會員編號查詢按鈕點擊事件
    $("#memIdSelecterButton").click(selectById);

    //透過選單查詢會員資料
    async function selectById() {
        let memId = $("#memIdSelecter").val();
        let path = window.location.pathname;
        let webCtx = path.substring(0, path.indexOf('/', 1));
        let url = webCtx + "/member/member.do?action=selectById&memId=" + memId;
        let response = await fetch(url, { method: 'get' });
        let members = await response.json();
        listMember(members);
    }

    //綁定輸入會員編號查詢按鈕事件
    $("#selectByInputbutton").click(checkInputMemberNumber);
    //確認輸入編號是否正確
    function checkInputMemberNumber() {
        let memId = $("#selectByInputinput").val();
        let evdience = false;
        for (let i = 0; i < memIdArray.length; i++) {
            if (memId == +memIdArray[i]) {
                evdience = true;
                break;
            }
        }
        if(!evdience){
            alert("輸入的會員編號有誤");
            return;
        }

        getMemberDataByInput(memId);
    };

    async function getMemberDataByInput(memId){
        let path = window.location.pathname;
        let webCtx = path.substring(0, path.indexOf('/', 1));
        let url = webCtx + "/member/member.do?action=selectById&memId=" + memId;

        let response = await fetch(url, { method: 'get' });
        let members = await response.json();
        listMember(members);
    }


    //綁定顯示所有會員資料按鈕事件
    $("#getAll").click(getAll)

    //取得所有會員資料
    async function getAll() {
        let path = window.location.pathname;
        let webCtx = path.substring(0, path.indexOf('/', 1));
        let url = webCtx + "/member/member.do?action=getAll";

        let response = await fetch(url, { method: 'get' });
        let members = await response.json();
        listMember(members);


    }
    //動態生成表格會員表格
    function listMember(members) {
        //移除原本存在的表格
        $("#listTable").empty();

        //生成表格
        let table = document.createElement("table");

        //生成表頭
        table.innerHTML += "<thead><tr><th>編號</th><th>帳號</th>"
            + "<th>姓名</th><th>手機</th><th>縣市</th><th>區域</th><th>路段</th>"
            + "<th>註冊時間</th><th>代幣數量</th><th>照片</th><th>帳號狀態</th><th>修改帳號狀態</th><th>會員儲值紀錄</th></tr></thead>";

        //生成表格內容
        let tbody = document.createElement("tbody");

        //循環依人數生成表格數量
        for (let i = 0; i < members.length; i++) {
            //處理註冊時間
            let date = new Date(members[i].memRegTime).toLocaleDateString();

            //修改會員狀態顯示結果不顯示數字而是文字

            let tr = document.createElement("tr");
            tr.insertAdjacentHTML("beforeend", `<td>${members[i].memId}</td>`);
            tr.insertAdjacentHTML("beforeend", `<td>${members[i].memEmail}</td>`);
            tr.insertAdjacentHTML("beforeend", `<td>${members[i].memName}</td>`);
            tr.insertAdjacentHTML("beforeend", `<td>${members[i].memMobile}</td>`);
            tr.insertAdjacentHTML("beforeend", `<td>${members[i].memCity ? members[i].memCity : ""}</td>`);
            tr.insertAdjacentHTML("beforeend", `<td>${members[i].memDist ? members[i].memDist : ""}</td>`);
            tr.insertAdjacentHTML("beforeend", `<td>${members[i].memAdr ? members[i].memAdr : ""}</td>`);
            tr.insertAdjacentHTML("beforeend", `<td>${date}</td>`);
            tr.insertAdjacentHTML("beforeend", `<td>${members[i].memToken}</td>`);
            if (members[i].memPic) {
                tr.insertAdjacentHTML("beforeend", `<td><img class="memPic" src=data:image/jpeg;base64,${members[i].memPic}></td>`);
            } else {
                tr.insertAdjacentHTML("beforeend", `<td></td>`);
            }

            if(members[i].accStat === 0){
                tr.insertAdjacentHTML("beforeend", `<td><select disabled id="select${members[i].memId}"><option selected value="0">正常</option><option value="1">停權</option></select></td>`);
            }else {
                tr.insertAdjacentHTML("beforeend", `<td><select disabled id="select${members[i].memId}"><option selected value="0">正常</option><option selected value="1">停權</option></select></td>`);
            }
            let buttonhtml = "<td><button id='accStateModify' name='aSTMbutton"+members[i].memId+"' value='"+members[i].memId+ "'>修改帳號狀態</button>" +
                             "<button style='display: none;margin-right: 0.5rem' id='cfbutton"+members[i].memId+"'>確認</button>"+
                             "<button style='display: none' id='clbutton"+members[i].memId+"'>取消</button></td>"

            tr.insertAdjacentHTML("beforeend", buttonhtml);

            tr.insertAdjacentHTML("beforeend", `<td><button id="memberTopUpList" value="${members[i].memId}">會員儲值紀錄</button></td></td>`);

            tbody.append(tr);
            tbody.append(tr);
        }
        table.append(tbody);
        table.setAttribute("class", "tableclass");
        $("#listTable").append(table);


        //綁定修改帳號狀態與查詢會員儲值紀錄事件
        addTableButtonWithFunction();
    }
    //綁定修改帳號狀態與查詢會員儲值紀錄事件
    function addTableButtonWithFunction() {
        let accStatebutton = document.querySelectorAll("#accStateModify");
        accStatebutton.forEach(e => e.addEventListener('click', accStateModify));

        // let memberTopUpListbutton = document.querySelectorAll("#memberTopUpList");
        // memberTopUpListbutton.forEach(e => e.addEventListener('click', memberTopUpList));

    }

    function accStateModify(e){
        let memId =  e.target.value;
        let selected = "select"+memId;
        let accState = $(`#${selected}`).val();
        let cfbutton = "cfbutton"+memId;
        let clbutton = "clbutton"+memId;
        let aSTMbutton = "aSTMbutton"+memId;

        $(`#${selected}`).prop("disabled",false);
        $(`[name=${aSTMbutton}]`).hide();
        $(`#${cfbutton}`).show();
        $(`#${clbutton}`).show();

        document.querySelector(`#${cfbutton}`).addEventListener("click",function () {
            changeButtonDisplay(selected,cfbutton,clbutton,aSTMbutton);
            updateAccState(accState,memId);
        })

        document.querySelector(`#${clbutton}`).addEventListener("click",function () {
            $(`#${selected}`).children(`[value='${accState}']`).prop("selected",true);
            changeButtonDisplay(selected, cfbutton, clbutton, aSTMbutton);
        })
    }



    function changeButtonDisplay(selected,cfbutton,clbutton,aSTMbutton){
        $(`#${selected}`).prop("disabled",true);
        $(`[name=${aSTMbutton}]`).show();
        $(`#${cfbutton}`).hide();
        $(`#${clbutton}`).hide();
    }


    function updateAccState(accState,memId){
        let path = window.location.pathname;
        let webCtx = path.substring(0, path.indexOf('/', 1));
        let url = webCtx + "/member/member.do?action=updateAccState&accState="+accState+"&memId="+memId;
        fetch(url, { method: 'get' });
    }






</script>
</body>
</html>